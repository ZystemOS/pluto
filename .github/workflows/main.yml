name: CI

on:
  push:
  pull_request:
    branches: '*'

jobs:
  test:
    name: Build mode ${{ matrix.build_mode }}
    runs-on: ubuntu-18.04
    strategy:
      matrix:
        build_mode: ["", -Drelease-fast, -Drelease-safe, -Drelease-small]

    steps:
    - uses: actions/checkout@v1

    - name: Install LLVM 13
      run: |
        wget https://apt.llvm.org/llvm.sh
        chmod +x llvm.sh
        sudo ./llvm.sh 13

    - name: Clone zig fork
      run: git clone https://github.com/ZystemOS/zig

    - name: Build zig fork
      run: |
        mkdir -p zig/build
        cd zig/build
        cmake .. -DCMAKE_C_COMPILER=clang-13 -DCMAKE_CXX_COMPILER=clang++-13
        make install

    - name: Install qemu
      run: |
        sudo apt-get update
        sudo apt-get install qemu qemu-system --fix-missing

    - name: Check formatting
      run: zig/build/zig fmt --check src

    - name: Build kernel
      run: zig/build/zig build ${{ matrix.build_mode }}

    - name: Run unit tests
      run: zig/build/zig build test ${{ matrix.build_mode }}

    - name: Run runtime test - Initialisation
      run: zig/build/zig build rt-test -Ddisable-display -Dtest-mode=Initialisation ${{ matrix.build_mode }}

    - name: Run runtime test - Panic
      run: zig/build/zig build rt-test -Ddisable-display -Dtest-mode=Panic ${{ matrix.build_mode }}

    - name: Run runtime test - Scheduler
      run: zig/build/zig build rt-test -Ddisable-display -Dtest-mode=Scheduler ${{ matrix.build_mode }}
